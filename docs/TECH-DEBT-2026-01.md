# Brain å°ˆæ¡ˆæŠ€è¡“å‚µå ±å‘Š

> å»ºç«‹æ—¥æœŸï¼š2026-01-19
> å°ˆæ¡ˆï¼šBrain - AI å®¢æœç³»çµ±ï¼ˆLINE è¨Šæ¯å¹³å°ï¼‰

---

## ğŸ“Š å°ˆæ¡ˆæ¦‚æ³

| æŒ‡æ¨™ | æ•¸å€¼ |
|------|------|
| å¾Œç«¯ Python æª”æ¡ˆ | 73 å€‹ |
| API è·¯ç”± | 17 å€‹ |
| æ¸¬è©¦æª”æ¡ˆ | 15 å€‹ |
| æ•´é«”å¥åº·åˆ†æ•¸ | 6.7/10 |

### æŠ€è¡“æ£§

- **å¾Œç«¯**ï¼šFastAPI + SQLAlchemy + PostgreSQL
- **å‰ç«¯**ï¼šReact 18 + Vite + Tailwind CSS
- **LLM**ï¼šClaude (Anthropic) + Gemini (Google) via OpenRouter
- **è¨Šæ¯å¹³å°**ï¼šLINE Bot SDK
- **å„²å­˜**ï¼šCloudflare R2ï¼ˆç…§ç‰‡ï¼‰

---

## ğŸ”´ P0 - åš´é‡å•é¡Œï¼ˆå¿…é ˆå„ªå…ˆè™•ç†ï¼‰

### 1. CRM å®¢æˆ¶ç«¯é‡è¤‡

**æª”æ¡ˆ**ï¼š
- `backend/services/jungle_client.py`ï¼ˆ465 è¡Œï¼‰
- `backend/services/crm_client.py`ï¼ˆ178 è¡Œï¼‰

**å•é¡Œæè¿°**ï¼š
å…©å€‹å®¢æˆ¶ç«¯åŠŸèƒ½éƒ¨åˆ†é‡ç–Šï¼Œä½†å¯¦ä½œæ–¹å¼ä¸åŒï¼š

| åŠŸèƒ½ | jungle_client | crm_client |
|------|---------------|------------|
| å®¢æˆ¶æŸ¥è©¢ | âœ… ç›´æ¥ PostgREST | âŒ ç„¡ |
| åˆç´„æŸ¥è©¢ | âœ… ç›´æ¥ PostgREST | âŒ ç„¡ |
| ç¹³è²»æŸ¥è©¢ | âœ… ç›´æ¥ PostgREST | âŒ ç„¡ |
| MCP å·¥å…·èª¿ç”¨ | éƒ¨åˆ†ï¼ˆcreate_leadï¼‰ | âœ… é€šç”¨ call_tool |
| å ±åƒ¹å–®å»ºç«‹ | âŒ ç„¡ | âœ… æœ‰ |
| éŒ¯èª¤è™•ç† | print() | logger |

**ä½¿ç”¨ä½ç½®**ï¼š
```
jungle_client (4 è™•)ï¼š
â”œâ”€â”€ brain/draft_generator.py
â”œâ”€â”€ services/booking_handler.py
â”œâ”€â”€ api/routes/analysis.py
â””â”€â”€ api/routes/webhooks.py

crm_client (1 è™•)ï¼š
â””â”€â”€ api/routes/quotes.py
```

**é¢¨éšª**ï¼š
- ç¶­è­·å…©å¥—ç¨‹å¼ç¢¼
- éŒ¯èª¤è™•ç†ä¸ä¸€è‡´
- æ–°åŠŸèƒ½ä¸çŸ¥é“è©²åŠ åœ¨å“ª

**å»ºè­°æ–¹æ¡ˆ**ï¼š
1. ä¿ç•™ `crm_client.py` ä½œç‚ºä¸»è¦å®¢æˆ¶ç«¯
2. å°‡ `jungle_client.py` çš„å®¢æˆ¶/åˆç´„/ç¹³è²»æŸ¥è©¢åŠŸèƒ½é·ç§»åˆ° `crm_client.py`
3. æ›´æ–°æ‰€æœ‰å¼•ç”¨
4. ç§»é™¤ `jungle_client.py`

---

### 2. Intent åˆ†é¡é‡è¤‡

**æª”æ¡ˆ**ï¼š
- `backend/brain/router.py` - JSON æ¨¡å¼ï¼ˆè®€å– `logic_tree.json`ï¼‰
- `backend/services/knowledge_service.py` - DB æ¨¡å¼ï¼ˆè®€å–è³‡æ–™åº«ï¼‰

**å•é¡Œæè¿°**ï¼š
å…©å€‹åœ°æ–¹éƒ½å¯ä»¥åšæ„åœ–åˆ†é¡ï¼Œé‚è¼¯ä¸ä¸€è‡´ã€‚

**é¢¨éšª**ï¼š
- åŒä¸€å€‹å•é¡Œå¯èƒ½åˆ†é¡ä¸åŒ
- ä¿®æ”¹é‚è¼¯è¦æ”¹å…©è™•

**å»ºè­°æ–¹æ¡ˆ**ï¼š
çµ±ä¸€ä½¿ç”¨ DB æ¨¡å¼ï¼Œç§»é™¤ JSON è¼‰å…¥é‚è¼¯ã€‚

---

### 3. Flex Message æ¨¡æ¿é‡è¤‡

**æª”æ¡ˆ**ï¼š
- `backend/brain/flex_templates.py`
- `backend/services/flex_templates.py`

**å•é¡Œæè¿°**ï¼š
LINE Flex Message æ¨¡æ¿åœ¨å…©å€‹åœ°æ–¹å®šç¾©ã€‚

**å»ºè­°æ–¹æ¡ˆ**ï¼š
ä¿ç•™ `services/flex_templates.py`ï¼Œç§»é™¤ `brain/flex_templates.py`ã€‚

---

## ğŸŸ¡ P1 - ä¸­ç­‰å•é¡Œ

### 4. å‹åˆ¥æç¤ºä¸å®Œæ•´

**ç¾æ³**ï¼š
| æ¨¡çµ„ | è¦†è“‹ç‡ |
|------|--------|
| services/ | ~60% |
| brain/ | ~47% |
| api/routes/ | ~50% |

**å½±éŸ¿çš„æª”æ¡ˆ**ï¼š
- `brain/draft_generator.py` - è¿”å›å‹åˆ¥ä¸æ˜ç¢º
- `services/rag_service.py` - æœå°‹çµæœå‹åˆ¥ä¸æ˜ç¢º

**å»ºè­°**ï¼šå»ºç«‹ `types.py` å…±ç”¨å‹åˆ¥å®šç¾©ã€‚

---

### 5. N+1 æŸ¥è©¢å•é¡Œ

**ä½ç½®**ï¼š`backend/api/routes/messages.py` çš„ `list_conversations()`

**å•é¡Œ**ï¼šåœ¨è¿´åœˆå…§æŸ¥è©¢æ¯å€‹å°è©±çš„æœ€å¾Œè¨Šæ¯ã€‚

**å»ºè­°**ï¼šä½¿ç”¨ JOIN æˆ–æ‰¹æ¬¡æŸ¥è©¢ã€‚

---

### 6. éŒ¯èª¤è™•ç†ä¸ä¸€è‡´

**ç¾æ³**ï¼š
- éƒ¨åˆ†æ¨¡çµ„ç”¨ `print()` è¼¸å‡ºéŒ¯èª¤
- éƒ¨åˆ†æ¨¡çµ„ç”¨ `logger`

**å»ºè­°**ï¼šçµ±ä¸€ä½¿ç”¨ `logging` æ¨¡çµ„ã€‚

---

## ğŸŸ¢ P2 - å¯æ”¹é€²é …ç›®

### 7. Prompt ç®¡ç†

**ç¾æ³**ï¼šPrompt ç¡¬ç·¨ç¢¼åœ¨ `backend/brain/prompts.py`ï¼Œç„¡ç‰ˆæœ¬æ§åˆ¶ã€‚

**å»ºè­°**ï¼šå»ºç«‹ Prompt ç‰ˆæœ¬ç®¡ç†ç³»çµ±ï¼ˆDB é©…å‹•ï¼‰ã€‚

---

### 8. çŸ¥è­˜åº«ç®¡ç†

**ç¾æ³**ï¼š`logic_tree.json`ã€`sales_mindmap.json` ç­‰ JSON æª”æ¡ˆåœ¨å•Ÿå‹•æ™‚è¼‰å…¥ã€‚

**å»ºè­°**ï¼šé·ç§»åˆ°è³‡æ–™åº«ï¼Œæ”¯æ´å‹•æ…‹æ›´æ–°ã€‚

---

## âœ… è™•ç†å„ªå…ˆé †åº

| é †åº | é …ç›® | å·¥ä½œé‡ | é¢¨éšª | ç‹€æ…‹ |
|------|------|--------|------|------|
| 1 | åˆä½µ CRM å®¢æˆ¶ç«¯ | M | ä½ | âœ… 2026-01-20 å®Œæˆ |
| 2 | ç§»é™¤é‡è¤‡ Flex æ¨¡æ¿ | S | ä½ | âœ… 2026-01-20 å®Œæˆï¼ˆåˆªé™¤æ­»ä»£ç¢¼ï¼‰ |
| 3 | çµ±ä¸€ Intent åˆ†é¡ | M | ä¸­ | â³ |
| 4 | è£œé½Šå‹åˆ¥æç¤º | L | ä½ | â³ |
| 5 | ä¿®å¾© N+1 æŸ¥è©¢ | S | ä½ | â³ |
| 6 | çµ±ä¸€éŒ¯èª¤è™•ç† | M | ä½ | â³ |
| 7 | Prompt ç‰ˆæœ¬ç®¡ç† | L | ä¸­ | â³ |
| 8 | çŸ¥è­˜åº« DB åŒ– | L | é«˜ | â³ |

---

## ğŸ“ é—œéµæª”æ¡ˆæ¸…å–®

| é¡åˆ¥ | æª”æ¡ˆ | è¡Œæ•¸ | èªªæ˜ |
|------|------|------|------|
| CRM | services/crm_client.py | ~450 | çµ±ä¸€ CRM å®¢æˆ¶ç«¯ï¼ˆæ•´åˆ PostgREST + MCP Toolsï¼‰ |
| è·¯ç”± | brain/router.py | 181 | Intent è·¯ç”±ï¼ˆJSON æ¨¡å¼ï¼‰ |
| çŸ¥è­˜ | services/knowledge_service.py | ~300 | çŸ¥è­˜åº«æœå‹™ï¼ˆDB æ¨¡å¼ï¼‰ |
| æ¨¡æ¿ | services/flex_templates.py | ~310 | Flex æ¨¡æ¿ï¼ˆç…§ç‰‡å±•ç¤ºï¼‰ |
| æ ¸å¿ƒ | brain/draft_generator.py | 300+ | LLM å›è¦†ç”Ÿæˆ |
| API | api/routes/messages.py | 653 | è¨Šæ¯ APIï¼ˆæœ‰ N+1ï¼‰ |

---

## ğŸ”§ æ¸¬è©¦è¦†è“‹ç‡

**ç›®å‰**ï¼š15 å€‹æ¸¬è©¦æª”æ¡ˆï¼Œä¸»è¦æ¸¬è©¦ `draft_generator.py`

**éœ€è¦è£œå……**ï¼š
- RAG Service æ¸¬è©¦
- Router æ¸¬è©¦
- æˆæœ¬è¨ˆç®—æ¸¬è©¦
- API æ•´åˆæ¸¬è©¦

---

*æ­¤å ±å‘Šç”± Claude Code è‡ªå‹•ç”Ÿæˆï¼ŒåŸºæ–¼ 2026-01-19 çš„ç¨‹å¼ç¢¼åˆ†æã€‚*
