#!/bin/bash

# ==============================================================================
# Brain AI ç³»çµ± - é ç¨‹éƒ¨ç½²è…³æœ¬ (å¾æœ¬æ©Ÿéƒ¨ç½²åˆ° GCP)
# ==============================================================================

set -e

# é¡è‰²å®šç¾©
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# GCP é…ç½®
PROJECT_ID="gen-lang-client-0281456461"
ZONE="us-west1-b"
VM_NAME="brain-ai-system"
REMOTE_PATH="/home/lgscvbatter/Brain"

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  Brain AI ç³»çµ± - é ç¨‹éƒ¨ç½²${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo -e "${YELLOW}å°ˆæ¡ˆï¼š${PROJECT_ID}${NC}"
echo -e "${YELLOW}VMï¼š${VM_NAME}${NC}"
echo -e "${YELLOW}Zoneï¼š${ZONE}${NC}"
echo ""

# ==============================================================================
# 1. æäº¤æœ¬åœ°è®Šæ›´
# ==============================================================================
echo -e "${GREEN}[1/4] æª¢æŸ¥æœ¬åœ°è®Šæ›´...${NC}"

if [[ -n $(git status --porcelain) ]]; then
    echo -e "${YELLOW}ç™¼ç¾æœªæäº¤çš„è®Šæ›´ï¼Œè«‹å…ˆæäº¤å¾Œå†éƒ¨ç½²${NC}"
    git status --short
    exit 1
fi

# ==============================================================================
# 2. æ¨é€åˆ° GitHub
# ==============================================================================
echo -e "${GREEN}[2/4] æ¨é€åˆ° GitHub...${NC}"
git push origin main

# ==============================================================================
# 3. è¨­å®š gcloud å°ˆæ¡ˆ
# ==============================================================================
echo -e "${GREEN}[3/4] è¨­å®š GCP å°ˆæ¡ˆ...${NC}"
gcloud config set project ${PROJECT_ID}

# ==============================================================================
# 4. é€£ç·šåˆ° VM ä¸¦éƒ¨ç½²
# ==============================================================================
echo -e "${GREEN}[4/4] é€£ç·šåˆ° VM ä¸¦éƒ¨ç½²...${NC}"

gcloud compute ssh --zone "${ZONE}" "${VM_NAME}" --command="
    # è¨­å®š safe.directory
    git config --global --add safe.directory ${REMOTE_PATH}

    cd ${REMOTE_PATH}

    echo 'ğŸ“¥ æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼...'
    git pull origin main

    echo 'ğŸ—ï¸ é‡æ–°å»ºç½®å®¹å™¨...'
    sudo docker compose build

    echo 'ğŸš€ é‡å•Ÿæœå‹™...'
    sudo docker compose up -d

    echo 'âœ… éƒ¨ç½²å®Œæˆï¼'
    sudo docker compose ps
"

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  ğŸ‰ éƒ¨ç½²å®Œæˆï¼${NC}"
echo -e "${GREEN}========================================${NC}"
